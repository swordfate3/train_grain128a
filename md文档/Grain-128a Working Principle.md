# Grain-128a 工作原理

## 1. 基本构成

### 主要组件
1. LFSR (Linear Feedback Shift Register)
 - 128位线性反馈移位寄存器
 - 用于产生良好的随机性和长周期序列
 
2. NFSR (Non-linear Feedback Shift Register)
 - 128位非线性反馈移位寄存器
 - 引入非线性性质，增加密码的复杂度

3. 预输出函数h(x)
 - 结合LFSR和NFSR的输出
 - 生成最终的密钥流

## 2. 工作流程

### 初始化阶段
1. 密钥装载
 - 128位密钥装入NFSR
 - 96位IV装入LFSR前96位
 - LFSR剩余位设置为1，最后一位为0

2. 初始化时钟
 - 运行256个时钟周期
 - 预输出反馈到LFSR和NFSR
 - 完成密钥和IV的混合

### 生成阶段
1. 不带认证模式 (IV0 = 0)
 - 直接使用预输出作为密钥流
 - zi = yi

2. 带认证模式 (IV0 = 1)
 - 每两个预输出位中取一个作为密钥流
 - zi = y64+2i
 - 另一个用于认证

## 3. 核心函数详解

### LFSR反馈函数f(x)
- 原始反馈多项式：
```
f(x) = 1 + x32 + x47 + x58 + x90 + x121 + x128
```
- 更新规则：
```
si+128 = si + si+7 + si+38 + si+70 + si+81 + si+96
```

### NFSR反馈函数g(x)
- 包含线性项和非线性项
- 非线性项最高达到4次项
- 更新规则包含与LFSR的交互

### 预输出函数h(x)
- 输入：9个状态变量（2个来自NFSR，7个来自LFSR）
- 非线性布尔函数
- 额外线性组合增强安全性

## 4. 认证机制

### 认证组件
1. 累加器（32位）
 - 初始化：前32位预输出
 - 用于累积认证信息

2. 移位寄存器（32位）
 - 初始化：接下来32位预输出
 - 用于处理消息比特

### 认证过程
1. 消息处理
 - 逐位处理消息
 - 与预输出流交互
 
2. 标签生成
 - 可变长度（最大32位）
 - 基于累加器最终状态